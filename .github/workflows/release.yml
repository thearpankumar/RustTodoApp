name: Build and Release (tag)

on:
  push:
    tags:
      - '**'

jobs:
  create_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref_name }}
          body: "Automatic release for tag ${{ github.ref_name }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux
    needs: create_release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 file

      - name: Install Packaging Tools
        run: |
          cargo install cargo-deb --locked
          cargo install cargo-generate-rpm

      - name: Build (Release)
        run: cargo build --release

      - name: Prepare Assets (Linux)
        run: |
          # Create .desktop file (Needed for AppImage, DEB and RPM)
          cat > todo_app.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Todo App
          Exec=todo_app
          Icon=todo_app
          Categories=Utility;
          EOF
          
          # Prepare Icon
          cp assets/icon.png todo_app.png

      - name: Create .deb
        run: |
          cargo deb -p todo_app
          mkdir -p release_artifacts
          cp target/debian/*.deb release_artifacts/

      - name: Create .rpm
        run: |
          cargo generate-rpm -p todo_app
          cp target/generate-rpm/*.rpm release_artifacts/

      - name: Create AppImage
        run: |
          # Download linuxdeploy
          wget -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy
          
          # Setup AppDir
          mkdir -p AppDir/usr/bin
          cp target/release/todo_app AppDir/usr/bin/
          cp todo_app.desktop AppDir/
          cp assets/icon.png AppDir/
          
          # Run linuxdeploy
          ./linuxdeploy --appdir AppDir --output appimage --icon-file todo_app.png --desktop-file todo_app.desktop
          
          # Move artifact
          mv Todo_App-*.AppImage release_artifacts/todo_app-${{ github.ref_name }}-x86_64.AppImage

      - name: Create Generic .tar.gz
        run: |
          tar -czf release_artifacts/todo_app-${{ github.ref_name }}-linux-generic.tar.gz -C target/release todo_app

      - name: Upload Linux Artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release_artifacts/*.deb
            release_artifacts/*.rpm
            release_artifacts/*.AppImage
            release_artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    needs: create_release
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Build (Release)
        shell: pwsh
        run: cargo build --release

      - name: Create .zip
        shell: pwsh
        run: |
          $out = "release_artifacts"
          New-Item -ItemType Directory -Path $out -Force | Out-Null
          $exe = "target\release\todo_app.exe"
          if (Test-Path $exe) {
             $zipPath = Join-Path $out "todo_app-${{ github.ref_name }}-windows.zip"
             Compress-Archive -Path $exe -DestinationPath $zipPath -Force
          }

      - name: Create .msi
        shell: pwsh
        run: |
          cargo install cargo-wix
          # Initialize wix for the specific package
          cargo wix init -p todo_app
          # Build MSI for the specific package with the icon
          cargo wix -p todo_app --product-icon assets/icon.ico
          
          # Move MSI to artifacts
          $out = "release_artifacts"
          $msi = Get-ChildItem "target\wix\*.msi" | Select-Object -First 1
          if ($msi) {
             Copy-Item $msi.FullName -Destination $out
          }

      - name: Upload Windows Artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release_artifacts/*.zip
            release_artifacts/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS
    needs: create_release
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Build (Release)
        run: cargo build --release

      - name: Create .tar.gz (macOS App Bundle)
        run: |
          mkdir -p "Todo App.app/Contents/MacOS"
          mkdir -p "Todo App.app/Contents/Resources"
          cp target/release/todo_app "Todo App.app/Contents/MacOS/"
          cp assets/icon.png "Todo App.app/Contents/Resources/"
          
          # Create a basic Info.plist
          cat > "Todo App.app/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>todo_app</string>
              <key>CFBundleIconFile</key>
              <string>icon.png</string>
              <key>CFBundleIdentifier</key>
              <string>com.arpankumar.todoapp</string>
              <key>CFBundleName</key>
              <string>Todo App</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ github.ref_name }}</string>
          </dict>
          </plist>
          EOF
          
          mkdir -p release_artifacts
          tar -czf release_artifacts/todo_app-${{ github.ref_name }}-macos.tar.gz "Todo App.app"

      - name: Upload macOS Artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: release_artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
